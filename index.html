<script>
  // ðŸ”‘ GANTI DENGAN DATA DARI DASHBOARD SUPABASE-MU
  const SUPABASE_URL = 'https://nmgquhrqfdbhhmcntrwx.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tcWN1aHJxZmRiaGhtY250cnd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUwNTQzMzMsImV4cCI6MjA1MDYzMDMzM30.eL7W8b4K7rN7vT8tDf9P3e3o1gXz3V3m';

  // Inisialisasi Supabase hanya sekali
  if (typeof window.supabase === 'undefined') {
    const { createClient } = supabase;
    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  let currentUser = null;

  const loginView = document.getElementById('login-view');
  const mainView = document.getElementById('main-view');
  const usernameInput = document.getElementById('username-input');
  const loginBtn = document.getElementById('login-btn');
  const greetingEl = document.getElementById('greeting');
  const navTabs = document.querySelectorAll('.nav-tab');
  const tabContents = document.querySelectorAll('.tab-content');

  // âœ… KUNCI PERUBAHAN: Periksa session storage, bukan localStorage
  document.addEventListener('DOMContentLoaded', () => {
    // Hapus localStorage lama jika ada (untuk migrasi)
    localStorage.removeItem('currentUser');
    
    // Periksa sessionStorage (hanya berlaku selama tab browser terbuka)
    const sessionUser = sessionStorage.getItem('nope_currentUser');
    
    if (sessionUser) {
      try {
        currentUser = JSON.parse(sessionUser);
        greetingEl.textContent = `Hello @${currentUser.username}`;
        loginView.classList.add('hidden');
        mainView.classList.remove('hidden');
        loadArtefaks('jejak');
        
        // Tambahkan tab Jelajah dengan CTA Logout
        setupJelajahTab();
      } catch (e) {
        // Jika ada error, reset ke login
        sessionStorage.removeItem('nope_currentUser');
        showLogin();
      }
    } else {
      // Tampilkan halaman login
      showLogin();
    }
  });

  function showLogin() {
    loginView.classList.remove('hidden');
    mainView.classList.add('hidden');
    usernameInput.focus();
  }

  loginBtn.addEventListener('click', () => {
    const username = usernameInput.value.trim();
    if (!username || username.split(' ').length !== 2) {
      alert('Username harus terdiri dari 2 kata, misal: "senja nope"');
      return;
    }
    
    currentUser = { 
      username,
      loginTime: new Date().toISOString()
    };
    
    // âœ… Simpan di sessionStorage, bukan localStorage
    sessionStorage.setItem('nope_currentUser', JSON.stringify(currentUser));
    
    greetingEl.textContent = `Hello @${username}`;
    loginView.classList.add('hidden');
    mainView.classList.remove('hidden');
    loadArtefaks('jejak');
    setupJelajahTab();
  });

  // Tab Navigation
  navTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      navTabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      tabContents.forEach(content => content.classList.add('hidden'));
      document.getElementById(`${tab.dataset.tab}-tab`).classList.remove('hidden');
      
      if (tab.dataset.tab === 'jelajah') {
        loadJelajahTab();
      } else {
        loadArtefaks(tab.dataset.tab);
      }
    });
  });

  // âœ… Fungsi untuk setup tab Jelajah
  function setupJelajahTab() {
    // Pastikan ada 4 nav tabs
    const navContainer = document.querySelector('.nav-tabs');
    if (navContainer.children.length === 4) {
      // Tab Jelajah sudah ada
      return;
    }
  }

  // âœ… Fungsi khusus untuk tab Jelajah
  async function loadJelajahTab() {
    const tray = document.getElementById('jelajah-tray');
    tray.innerHTML = '';
    
    // Kartu 1: Setting User
    const settingCard = document.createElement('div');
    settingCard.className = 'artefak-card';
    const settingContent = document.createElement('div');
    settingContent.style.padding = '16px';
    settingContent.style.height = '100%';
    settingContent.style.display = 'flex';
    settingContent.style.flexDirection = 'column';
    settingContent.style.justifyContent = 'space-between';
    
    // Info User
    const userInfo = document.createElement('div');
    userInfo.innerHTML = `
      <h3 style="margin-bottom: 8px; color: var(--accent-blue);">Pengaturan</h3>
      <p style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 16px;">
        Username: <strong>${currentUser.username}</strong><br>
        Login: ${new Date(currentUser.loginTime).toLocaleTimeString('id-ID')}
      </p>
    `;
    
    // Tombol Logout
    const logoutBtn = document.createElement('button');
    logoutBtn.textContent = 'Logout';
    logoutBtn.style.background = 'transparent';
    logoutBtn.style.border = '1px solid rgba(255,255,255,0.3)';
    logoutBtn.style.marginTop = '16px';
    logoutBtn.addEventListener('click', handleLogout);
    
    settingContent.appendChild(userInfo);
    settingContent.appendChild(logoutBtn);
    settingCard.appendChild(settingContent);
    tray.appendChild(settingCard);
    
    // Kartu 2-6: Fitur Jelajah lainnya
    const jelajahFeatures = [
      { title: 'Trending', desc: 'Artefak viral hari ini' },
      { title: 'Discovery', desc: 'Temukan pengguna baru' },
      { title: 'Peta Jejak', desc: 'Visualisasi perjalanan' },
      { title: 'Statistik', desc: 'Aktivitas Anda' },
      { title: 'Komunitas', desc: 'Grup dan diskusi' }
    ];
    
    for (let i = 0; i < 5; i++) {
      const card = document.createElement('div');
      card.className = 'artefak-card';
      const content = document.createElement('div');
      content.style.padding = '16px';
      content.style.height = '100%';
      content.style.display = 'flex';
      content.style.flexDirection = 'column';
      content.style.justifyContent = 'center';
      
      content.innerHTML = `
        <h3 style="margin-bottom: 8px; color: var(--accent-blue);">${jelajahFeatures[i].title}</h3>
        <p style="font-size: 12px; color: rgba(255,255,255,0.5);">
          ${jelajahFeatures[i].desc}
        </p>
      `;
      
      card.appendChild(content);
      tray.appendChild(card);
    }
  }

  // âœ… Fungsi Logout
  function handleLogout() {
    if (confirm('Yakin ingin logout?')) {
      // Hapus session
      sessionStorage.removeItem('nope_currentUser');
      currentUser = null;
      
      // Reset form
      usernameInput.value = '';
      
      // Tampilkan login
      showLogin();
      
      // Reset tab ke Jejak
      navTabs.forEach(t => t.classList.remove('active'));
      document.querySelector('.nav-tab[data-tab="jejak"]').classList.add('active');
      tabContents.forEach(content => content.classList.add('hidden'));
      document.getElementById('jejak-tab').classList.remove('hidden');
    }
  }

  async function loadArtefaks(tabName) {
    const trayId = `${tabName}-tray`;
    const tray = document.getElementById(trayId);
    tray.innerHTML = '';

    for (let i = 0; i < 6; i++) {
      const card = document.createElement('div');
      card.className = 'artefak-card';
      if (i === 0) {
        const btn = document.createElement('div');
        btn.className = 'upload-btn';
        btn.textContent = 'Unggah';
        btn.addEventListener('click', () => uploadArtefak(tabName));
        card.appendChild(btn);
      } else {
        const placeholder = document.createElement('div');
        placeholder.style.backgroundColor = '#222';
        placeholder.style.display = 'flex';
        placeholder.style.alignItems = 'center';
        placeholder.style.justifyContent = 'center';
        placeholder.style.color = '#555';
        placeholder.style.height = '100%';
        placeholder.textContent = 'â€”';
        card.appendChild(placeholder);
      }
      tray.appendChild(card);
    }

    // âœ… Gunakan window.supabase.from
    const { data, error } = await window.supabase
      .from('artefaks')
      .select('*')
      .eq('category', tabName)
      .eq('user_id', currentUser.username)
      .order('created_at', { ascending: false })
      .limit(5);

    if (!error && data && data.length > 0) {
      const cards = tray.querySelectorAll('.artefak-card');
      data.forEach((artefak, idx) => {
        if (idx + 1 < cards.length) {
          const card = cards[idx + 1];
          card.innerHTML = '';
          const img = document.createElement('img');
          img.src = artefak.image_url;
          img.alt = 'Artefak';
          img.loading = 'lazy';
          card.appendChild(img);
          if (artefak.notasi) {
            const notasi = document.createElement('div');
            notasi.className = 'notasi';
            notasi.textContent = artefak.notasi;
            card.appendChild(notasi);
          }
        }
      });
    }
  }

  async function uploadArtefak(category) {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const filePath = `public/${currentUser.username.replace(/\s+/g, '_')}/${Date.now()}.jpg`;
      const { data, error } = await window.supabase.storage
        .from('artefak')
        .upload(filePath, file, { contentType: 'image/jpeg', upsert: false });

      if (error) {
        alert('Gagal upload. Coba lagi!');
        console.error(error);
        return;
      }

      const { publicUrl } = window.supabase.storage
        .from('artefak')
        .getPublicUrl(data.path);

      const notasi = prompt('Masukkan notasi (maks 4 kata):', 'Senja abadi');
      if (!notasi) return;

      // âœ… Gunakan window.supabase.from + tambahkan category
      const { error: insertError } = await window.supabase
        .from('artefaks')
        .insert({
          user_id: currentUser.username,
          image_url: publicUrl,
          notasi: notasi,
          note: '',
          category: category
        });

      if (insertError) {
        alert('Gagal simpan metadata.');
        console.error(insertError);
      } else {
        loadArtefaks(category);
      }
    };
    input.click();
  }
</script>
